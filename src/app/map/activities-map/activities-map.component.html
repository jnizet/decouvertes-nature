<dn-page-title title="Carte des activités" />
<ng-container *ngIf="vm$ | async as vm; else loading">
  <div class="row">
    <div class="col">
      <h1>Carte <span class="d-none d-sm-inline">des activités</span></h1>
    </div>
    <div class="col-auto">
      <a routerLink="/activities/new" class="btn btn-outline-secondary">
        <dn-icon class="me-1" [icon]="icons.addActivity" />
        Créer une activité
      </a>
    </div>
  </div>

  <dn-year-selector />
  <div class="row">
    <div class="col-md-8 order-md-1 mb-4 mb-md-0">
      <div class="map border rounded">
        <dn-map
          [locations]="vm.mappedLocations"
          [focusedLocation]="vm.focusedLocation"
          class="d-block w-100 h-100"
        />
      </div>
    </div>
    <div class="col-md-4 order-md-0">
      <div
        *ngIf="vm.mappedLocations.length + vm.unmappedLocations.length === 0"
        class="text-muted mt-md-4"
      >
        Aucune activité en {{ vm.year }}
      </div>
      <ng-container *ngIf="vm.mappedLocations.length">
        <h2 class="fs-5" [class.visually-hidden]="vm.unmappedLocations.length === 0">
          Sur la carte
        </h2>
        <div
          *ngFor="
            let location of vm.mappedLocations;
            index as locationIndex;
            trackBy: byMunicipality
          "
          class="card mb-2"
          (mouseenter)="setFocusedLocation(location)"
          (mouseleave)="setFocusedLocation(null)"
          role="button"
          tabindex="0"
          (keyup.enter)="toggle(location)"
          (click)="toggle(location)"
          [attr.aria-expanded]="!location.collapsed"
          [attr.aria-controls]="'location-' + locationIndex"
        >
          <dn-location
            class="card-body"
            [location]="location"
            [title]="location.municipality.name"
            [collapsedId]="'location-' + locationIndex"
          />
        </div>
      </ng-container>
      <ng-container *ngIf="vm.unmappedLocations.length">
        <h2 class="fs-5">Hors carte</h2>
        <p class="text-muted small">
          Les lieux ci-dessous ne sont pas sur la carte parce qu'ils ne sont pas une commune de la
          Loire connue par l'application.
        </p>
        <div
          *ngFor="
            let location of vm.unmappedLocations;
            trackBy: byUnmappedLocation;
            index as unmappedLocationIndex
          "
          class="card unmapped mb-2"
          role="button"
          (click)="toggleUnmapped(location)"
          tabindex="0"
          (keyup.enter)="toggleUnmapped(location)"
          [attr.aria-expanded]="!location.collapsed"
          [attr.aria-controls]="'unmapped-location-' + unmappedLocationIndex"
        >
          <dn-location
            class="card-body"
            [location]="location"
            [title]="location.location || 'Non renseigné'"
            [collapsedId]="'unmapped-location-' + unmappedLocationIndex"
          />
        </div>
      </ng-container>
    </div>
  </div>
</ng-container>
<ng-template #loading>
  <dn-loading-spinner />
</ng-template>
